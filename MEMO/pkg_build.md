# PKGBUILDのメモ

## パッケージングプロセス

1. 依存パッケージがインストールされているかを確認する。 
2. ソースをサーバーからダウンロードする
3. 圧縮されたソースファイルを展開する。
4. fakeroot環境でコンパイル、インストールを行う
5. バイナリやライブラリから不要なシンボルを除去する。(symbol stripping)
6. パッケージのメタデータを生成する。
7. fakeroot環境をパッケージに圧縮する
8. パッケージファイル(\*.pkg.tar.zst)を出力ディレクトリに保存する。デフォルトでは作業ディレクトリ

## PKGBUILDの変数

- <b>srcdir</b>
   - <b>makepkg</b>がソースファイルを展開またはコピーしてくるディレクトリ 
- <b>pkgdir</b>
   - build()が終わった後で<b>makepkg</b>はここに生成されたファイルをパッケージに入れる。
   - すなわちここがパッケージのrootとなる

## PKGBUILDの関数

- build(),package()は対話的になるようになってはならない。
- package()は必須の関数で、省略することはできない。

- prepare(): pacman 4.1から導入された
    - パッチなどのソースコードをビルドする前の準備段階で実行されるコマンドの実行を行う。
    - build()の前,パッケージの展開の後で実行される
    - makepkg -eと展開を省略した場合では実行されない。

- pkgver(): pacman 4.1から
    - makepkgの実行中にpkgverの変数を更新することができる。 
    - ソースが取得・展開された後すぐに実行される。
    - git/svn/hgなどのパッケージを作成するときに便利

- build()

    - Bashの文法に基づいてソースコードから目的のバイナリをビルドするために用いられる。
    - 多くの場合まずsrcdirへの移動からスタートする

```bash
cd "${srcdir}/$pkgname-$pkgdir"
```
-  
    - ビルドが完了するとpkgディレクトリが作成されて、目的のバイナリはここにインストールされる
    - ビルドのコマンド群は手動でビルドする場合と同じものを用いる
    - 例えば、cofigureを用いているならば--prefix=/usr
    - インストール先は/usr下にするべきである。/usr/localは手動の場合にのみ用いられるべきである。
    - ビルドする必要のないパッケージの場合(ex. all pythonのアプリ)はbuild()関数は仕様するべきでない。

```bash
./configure --prefix=/usr
make
```

- check()
