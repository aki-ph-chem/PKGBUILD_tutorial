# PKGBUILDの変数

PKGBUILD全体のまとめに書いていたら量がとても多かったので分離した。

[PKGBUILDの記事](https://wiki.archlinux.jp/index.php/PKGBUILD)はここ

PKGBUILDには多くの変数があるが必ず設定しなければならないのは `pkgname`,`pkgver`,`pkgrel`,`arch`の4個である。
`license`はなくてもビルドできるが警告が出るため他人と共有するようなPKGBUILDには書くことが推奨されている。

## パッケージ名

- pkgname
    - pkgnameはソースのtarballの名前と一致させるべきである。
    - 例えばソースが\<name\>-\<version\>.tar.gzならばpkgnameは\<name\>と一致させるべき。

## バージョン

- pkgver
    - もしバージョンが*0.99-10*のようにハイフンで区切られている場合は*0.99_10*のようにアンダーバーに置き換えなければならない。

- pkgrel
    - Arch Linuxにおけるパッケージのリリース番号でパッケージの同じバージョンを続けてビルドするときにそれを区別するためにこの値を使う。
    - リリース番号は1からスタートして修正・最適が行われるたびにパッケージは再リリースされてリリース番号は1づつ増やされる。

## 汎用

- pkgdesc
    - パッケージの説明でアプリケーションの名前がパッケージ名と異なる場合を除いて、パッケージ名を自己参照しないようにしなければならない

- arch
    - PKGBUILDがビルド・動作するアーキテクチャの文字列で`i686`,`x86_64`が使用可能である。
    - シェルスクリプトのようなアーキテクチャに依存しない場合では`any`を使うことが推奨されている。

- url
    - パッケージされるソフトウェアの公式サイトのURL

- license
    - ソフトウェアのライセンス

## 依存関係

- groups
    - パッケージが属するグループ
    - 例えばはplasmaをパッケージのグループであり、これをインストールするとそのグループの属する全てのパッケージがインストールされる。

- depends
    - ソフトウェアを実行する前にインストールする必要のあるパッケージ
    - ソフトウェアの依存パッケージに最低必要バージョンがあるときは、`>=`演算子を用いて表現する。

例
```bash
depends=('foobar>=1.8.0')
```
- optdepends
    - パッケージを機能させるのに必ずしも必要ではないが、機能を追加することができるパッケージの名前

- makedepends
    - ビルドを実行するためには必要ではあるが、ビルド後は必要ないパッケージ名
    - `depends`と同じフォーマットを使って記述する。

- checkdepends
    - テストを実行するのには必要ではあるが、実行時には必要のないパッケージの名前
    - `depends`と同じフォーマットで記述する。
    - check()関数がmakepkgによって実行される時にだけこの依存関係が考慮される。

## パッケージの関係性

- provides
    - あるパッケージの機能を別の名前で提供するパッケージの名前。
    - 同じものを(別の名前で)提供するパッケージは互いに衝突しない限り同時にインストールが可能。
    - ただし、特定のバージョンによって影響を受ける依存関係がある場合はパッケージが提供するバージョン(pkgver, pkgrel)を追加せよ。
    - 例えばqtにモディファイを加えてqt-foobarのバージョン3.38を作成する場合では`provedes`に`provides=('qt=3.38')`とする。
    - `provides=('qt')`とするとqtの特定バージョンを必要とする依存関係が破壊されてしまう。
    - 特に`provides`の行に`pkgname`を加えると自動で追加されてしまうので加えてはいけない。

- conflicts
    - インストールすると問題が生じるパッケージの名前
    - この名前を持つパッケージとこの名前の

- replaces
    - パッケージによって置き換えられる廃止パッケージの名前 
    - たとえばwiresharkが廃止パッケージとなってwireshark-qtパッケージが代替となる場合は
    - `replaces=('wireshark')`とする。リポジトリ内に`replaces`に一致するパッケージが現れるとインストールされたパッケージは置き換えられる。
    - 既存パッケージの別バージョンを提供するときには、衝突するパッケージをインストールするときに評価される配列変数`conflicts`, `provides`を使う。

## その他

- backup
    - パッケージのアップグレードや削除が行われても維持されるファイルの文字列で主に`/etc`に保存される設定ファイル名。 
    - アップデート時、既存のファイルを上書きしないように新しいバージョンは`file.pacnew`として保存される。
    - パッケージ削除時では`pacman -Rn`コマンドを使わなければユーザーが修正したファイルは`file.pacsave`として残される。
    - ここで記述するファイルパスは相対パス`etc/foo.conf`とすること。

- options
    - `makepkg`の挙動はデフォルトの`/etc/makepkg.conf`に従うがこの文字列によって一部を上書きができる。
    - デフォルトの挙動を逆にするにはオプションの前に`!`をつける。
    - 以下に有効なオプションを挙げる。 

    1. strip: バイナリからシンボルを除去デバッガを頻繁に使う場合ではこのオプションを無効化すると便利。
    2. docs: /docディレクトリを保存
    3. libtool: パッケージにlibtool(`.la`)ファイルを残す
    4. staticlibs: パッケージに静的ライブラリ(.a)のファイルを残す。
    5. emptydirs: パッケージにからのディレクトリを残す。
    6. zipman: manとinfoページをgzipで圧縮
    7. purge: パッケージの`PURGE_TARGETS`変数で指定されてファイルを削除 
    8. upx: UPXを使って実行可能なバイナリを圧縮。`UPXFLAGS`変数を指定することでUPXに追加オプションを渡す。
    9. ccache: ビルド中の`ccache`の使用を許可。無効化したければ`!ccache`とする。
    10. distcc: ビルド中の`distcc`の使用を許可。無効化したければ`!distcc`とする。
    11. buildflags: ビルド中にユーザー定義の`buildflags`(CFLAGS, CXXFLAGS, LDFLAGS)の使用を許可。
    12. makeflags: ビルド中のユーザー定義の`makeflags`の使用を許可。

- install
    - パッケージに含まれる`.install`スクリプトの名前`pkgname`と同じ名前にする。

- changelog
    - パッケージの変更履歴の名前。新ストールされたパッケージの変更履歴を表示するには
```
$ pacman -Qc <pkgname>
```
## ソース

- source
    - パッケージをビルドするのに必要なファイルの文字列。多くの場合HTTP,FTPのURL
    - 例:`source=(http://example.com/$pkgname-$pkgver.tar.gz)`
    - ローカルにおいたソースからビルドする場合では`PKGBUILD`のあるディレクトリと同じ場所に置く

- noextract
    - source行でmakepkgによって展開したくない圧縮フォーマットのファイル名
    - 多くの場合では`/usr/bin/bsdtar`によって扱えない圧縮ファイルに`noextract`を使う。
    - この場合では`unzip`や`p7zip`などを`makedepends`に追加してprepare()関数の最初の行に展開処理を書く

```bash
prepare() {
    lrzip -d <source>.tar.lrz
}
```

`source`行にはURLを指定することが可能であるが`noextract`にはファイル名の一部だけを指定する。

```bash
source=("http://ftp.archlinux.org/other/grub2/grub2_extras_lua_r20.tar.xz")
noextract=("grub2_extras_lua_r20.tar.xz")
```

## 整合性

ファイルをある配布先からダウンロードした時に途中で改ざんされてしまうことがある。
そこで、ダウンロードする前のファイルのデータ列を整数値の列とみなして和を求め、
これをある定数で割ったあまりを求めこれを検査用のデータとする。
この値をダウンロード後に確かめることでファイルの同一性を保証することができる。


PKGBUILDでは多くの場合では配布先からソースをダウンロードする。
そのため`source`配列の書かれたファイルの整合性をチェックするための変数がある。
サムチェックを行いたくない場合では`SKIP`とする。

これらの変数を生成するには`makepkg`コマンドの`-g/--geninteg`オプションを用いる。
一般的には

```
$ makepkg -g >> PKGBUILD
```

で追加する。使用する整合性のチェックは`/etc/makepkg.conf`の`INTEGITY_CHECK`オプションで設定ができる。

より高度なデジタル署名を用いたい場合では署名ファイルを`source`配列にPGP鍵のフィンガープリントを`validgpgkeys`配列に追加する必要がある。

- validpgpkeys
    - PGP鍵のフィンガープリントの配列
    - `validpgpkeys`を使用した場合、`makepkg`は配列`validpgpkeys`に記載されている鍵の署名だけを使うようにする。
